<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Suspense | 王亚宁的个人学习</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.1a8e0fbc.css" as="style"><link rel="preload" href="/assets/js/app.99b5bf8c.js" as="script"><link rel="preload" href="/assets/js/2.733019b2.js" as="script"><link rel="preload" href="/assets/js/33.81844ad5.js" as="script"><link rel="prefetch" href="/assets/js/10.6d1d7980.js"><link rel="prefetch" href="/assets/js/11.25fb5d69.js"><link rel="prefetch" href="/assets/js/12.bc1ec79e.js"><link rel="prefetch" href="/assets/js/13.374735a3.js"><link rel="prefetch" href="/assets/js/14.d1314cfe.js"><link rel="prefetch" href="/assets/js/15.17b5a911.js"><link rel="prefetch" href="/assets/js/16.e0c10874.js"><link rel="prefetch" href="/assets/js/17.ac034782.js"><link rel="prefetch" href="/assets/js/18.ad32bacc.js"><link rel="prefetch" href="/assets/js/19.feb7eb65.js"><link rel="prefetch" href="/assets/js/20.4d1669ae.js"><link rel="prefetch" href="/assets/js/21.58e133ab.js"><link rel="prefetch" href="/assets/js/22.4fda5adb.js"><link rel="prefetch" href="/assets/js/23.eca9f50e.js"><link rel="prefetch" href="/assets/js/24.e6e7dbdc.js"><link rel="prefetch" href="/assets/js/25.c9789b89.js"><link rel="prefetch" href="/assets/js/26.156cb2a0.js"><link rel="prefetch" href="/assets/js/27.eb596818.js"><link rel="prefetch" href="/assets/js/28.fa8f9629.js"><link rel="prefetch" href="/assets/js/29.2013f0a2.js"><link rel="prefetch" href="/assets/js/3.dca13282.js"><link rel="prefetch" href="/assets/js/30.88192890.js"><link rel="prefetch" href="/assets/js/31.b02f53c7.js"><link rel="prefetch" href="/assets/js/32.d9d2cc26.js"><link rel="prefetch" href="/assets/js/34.becf5ac9.js"><link rel="prefetch" href="/assets/js/35.e3e5a33b.js"><link rel="prefetch" href="/assets/js/36.215dbd6f.js"><link rel="prefetch" href="/assets/js/37.84c02384.js"><link rel="prefetch" href="/assets/js/38.a4c03307.js"><link rel="prefetch" href="/assets/js/39.3640528f.js"><link rel="prefetch" href="/assets/js/4.da3ef268.js"><link rel="prefetch" href="/assets/js/40.d07751f5.js"><link rel="prefetch" href="/assets/js/41.ca2fb91b.js"><link rel="prefetch" href="/assets/js/42.29bd46cc.js"><link rel="prefetch" href="/assets/js/43.078b0578.js"><link rel="prefetch" href="/assets/js/44.8bc1ef68.js"><link rel="prefetch" href="/assets/js/45.b63b3129.js"><link rel="prefetch" href="/assets/js/46.baf5c7c5.js"><link rel="prefetch" href="/assets/js/47.553e39ba.js"><link rel="prefetch" href="/assets/js/48.3b0f6b8f.js"><link rel="prefetch" href="/assets/js/49.0711a1e9.js"><link rel="prefetch" href="/assets/js/5.dac787d8.js"><link rel="prefetch" href="/assets/js/50.7717d267.js"><link rel="prefetch" href="/assets/js/6.820ab661.js"><link rel="prefetch" href="/assets/js/7.7f0c0f6a.js"><link rel="prefetch" href="/assets/js/8.8733fc27.js"><link rel="prefetch" href="/assets/js/9.76eb16d3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1a8e0fbc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">王亚宁的个人学习</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/react/react.html" class="nav-link">
  我学习的react
</a></div><div class="nav-item"><a href="/vue/v-model.html" class="nav-link">
  我学习的vue
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/react/react.html" class="nav-link">
  我学习的react
</a></div><div class="nav-item"><a href="/vue/v-model.html" class="nav-link">
  我学习的vue
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>react源码</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/react.html" class="sidebar-link">React</a></li><li><a href="/react/ref.html" class="sidebar-link">createRef</a></li><li><a href="/react/scheduler.html" class="sidebar-link">React是如何调度任务的</a></li><li><a href="/react/react-16.6.html" class="sidebar-link">React16.6</a></li><li><a href="/react/react-scheduler.html" class="sidebar-link">react scheduler</a></li><li><a href="/react/component.html" class="sidebar-link">React.Component</a></li><li><a href="/react/context.html" class="sidebar-link">Stack</a></li><li><a href="/react/diff-properties.html" class="sidebar-link">diffProperties</a></li><li><a href="/react/finalizeInitialChildren.html" class="sidebar-link">finalizeInitialChildren</a></li><li><a href="/react/hooks-common.html" class="sidebar-link">阅读源码后，来讲讲React Hokks是怎么实现的</a></li><li><a href="/react/hooks.html" class="sidebar-link">从源码看Hooks</a></li><li><a href="/react/complete-unit-of-work.html" class="sidebar-link">completeUnitOfWork</a></li><li><a href="/react/complete-work.html" class="sidebar-link">completeWork</a></li><li><a href="/react/pending-priority-methods.html" class="sidebar-link">markPendingPriorityLevel</a></li><li><a href="/react/pending-priority.html" class="sidebar-link">PendingPriority</a></li><li><a href="/react/stack-context.html" class="sidebar-link">Stack</a></li><li><a href="/react/start.html" class="sidebar-link">React是如何调度任务的</a></li><li><a href="/react/suspense-core.html" aria-current="page" class="active sidebar-link">Suspense</a></li><li><a href="/react/suspense.html" class="sidebar-link">开启</a></li><li><a href="/react/time.html" class="sidebar-link">Time About</a></li><li><a href="/react/unwind-work.html" class="sidebar-link">unwindWork</a></li><li><a href="/react/update-queue.html" class="sidebar-link">updateQueue</a></li><li><a href="/react/why-new-context-api.html" class="sidebar-link">Context API</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="suspense"><a href="#suspense" class="header-anchor">#</a> Suspense</h1> <p><code>suspense</code>的原理是通过<code>throw thenable</code>，然后显示<code>Suspense</code>组件的<code>fallback</code>，等到<code>thenable</code>状态变更之后再根据结果进行渲染。所以核心肯定就是在如何处理抛出的<code>thenable</code>对象。</p> <p>略长的代码，我们可以区分来看，注意这里每个循环向抛出异常的组件的父链上找所有<code>Suspense</code>组件。先看第一个<code>do while</code>循环，这个循环并不是特别重要，主要是找两个时间值：</p> <ul><li><code>startTimeMs</code></li> <li><code>earliestTimeoutMs</code></li></ul> <p>前者跟上一次<code>Suspense</code>组件被<code>commit</code>的时间有关，在<code>commitAllLifecycle</code>中被设置。</p> <p>后者跟我们设置在<code>Suspense</code>组件上的属性<code>maxDuration</code>有关，大致意思是过多少毫秒之后才真正被提交。</p> <p>然后进入第二个循环，首先绑定抛出的异常状态变化之后的处理函数<code>retrySuspendedRoot</code>。</p> <p>其次这个循环主要根据<code>Suspense</code>组件是否处于<code>ConcurrentMode</code>进行不同的处理</p> <h4 id="没有处于concurrentmode"><a href="#没有处于concurrentmode" class="header-anchor">#</a> 没有处于<code>ConcurrentMode</code></h4> <p>这种情况会从简处理，在本次渲染中并不进行异常捕获，直接把异常节点以<code>null</code>进行渲染，并且增加<code>Incomplete</code>副作用，让后面<code>completeUnitOfWork</code>的时候走<code>unwindWork</code>的流程。并且如果报错的组件是<code>ClassComponent</code>同时是初次渲染，标记组件为<code>IncompleteClassComponent</code>，他在后面的更新过程中会特殊处理，主要区别是要删除<code>current</code>，完全按照初次渲染进行。</p> <h4 id="对于处于concurrentmode"><a href="#对于处于concurrentmode" class="header-anchor">#</a> 对于处于<code>ConcurrentMode</code></h4> <p>这种情况会走正常<code>Capture</code>流程，会增加<code>ShouldCapture</code>副作用，然后根据``</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">throwException</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
  <span class="token literal-property property">returnFiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">sourceFiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> mixed<span class="token punctuation">,</span>
  <span class="token literal-property property">renderExpirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  sourceFiber<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Incomplete
  sourceFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> sourceFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    value <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">typeof</span> value<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is a thenable.</span>
    <span class="token keyword">const</span> <span class="token literal-property property">thenable</span><span class="token operator">:</span> Thenable <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> any<span class="token punctuation">)</span>

    <span class="token keyword">let</span> workInProgress <span class="token operator">=</span> returnFiber
    <span class="token keyword">let</span> earliestTimeoutMs <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">let</span> startTimeMs <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag <span class="token operator">===</span> SuspenseComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>alternate
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token literal-property property">currentState</span><span class="token operator">:</span> SuspenseState <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState
          <span class="token keyword">if</span> <span class="token punctuation">(</span>currentState <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> currentState<span class="token punctuation">.</span>didTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Reached a boundary that already timed out. Do not search</span>
            <span class="token comment">// any further.</span>
            <span class="token keyword">const</span> timedOutAt <span class="token operator">=</span> currentState<span class="token punctuation">.</span>timedOutAt
            startTimeMs <span class="token operator">=</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span>timedOutAt<span class="token punctuation">)</span>
            <span class="token comment">// Do not search any further.</span>
            <span class="token keyword">break</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> timeoutPropMs <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">.</span>maxDuration
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> timeoutPropMs <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutPropMs <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            earliestTimeoutMs <span class="token operator">=</span> <span class="token number">0</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
            earliestTimeoutMs <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span>
            timeoutPropMs <span class="token operator">&lt;</span> earliestTimeoutMs
          <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            earliestTimeoutMs <span class="token operator">=</span> timeoutPropMs
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      workInProgress <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>return
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>

    <span class="token comment">// Schedule the nearest Suspense to re-render the timed out view.</span>
    workInProgress <span class="token operator">=</span> returnFiber
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        workInProgress<span class="token punctuation">.</span>tag <span class="token operator">===</span> SuspenseComponent <span class="token operator">&amp;&amp;</span>
        <span class="token function">shouldCaptureSuspense</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>alternate<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> pingTime <span class="token operator">=</span>
          <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ConcurrentMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoEffect
            <span class="token operator">?</span> Sync
            <span class="token operator">:</span> renderExpirationTime

        <span class="token comment">// Attach a listener to the promise to &quot;ping&quot; the root and retry.</span>
        <span class="token keyword">let</span> onResolveOrReject <span class="token operator">=</span> <span class="token function">retrySuspendedRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
          <span class="token keyword">null</span><span class="token punctuation">,</span>
          root<span class="token punctuation">,</span>
          workInProgress<span class="token punctuation">,</span>
          sourceFiber<span class="token punctuation">,</span>
          pingTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          onResolveOrReject <span class="token operator">=</span> <span class="token function">Schedule_tracing_wrap</span><span class="token punctuation">(</span>onResolveOrReject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        thenable<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onResolveOrReject<span class="token punctuation">,</span> onResolveOrReject<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ConcurrentMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> CallbackEffect

          <span class="token comment">// Unmount the source fiber's children</span>
          <span class="token keyword">const</span> nextChildren <span class="token operator">=</span> <span class="token keyword">null</span>
          <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
            sourceFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">,</span>
            sourceFiber<span class="token punctuation">,</span>
            nextChildren<span class="token punctuation">,</span>
            renderExpirationTime<span class="token punctuation">,</span>
          <span class="token punctuation">)</span>
          sourceFiber<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Incomplete

          <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> ClassComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sourceFiber<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>LifecycleEffectMask
            <span class="token keyword">const</span> current <span class="token operator">=</span> sourceFiber<span class="token punctuation">.</span>alternate
            <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              sourceFiber<span class="token punctuation">.</span>tag <span class="token operator">=</span> IncompleteClassComponent
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// Exit without suspending.</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> absoluteTimeoutMs
        <span class="token keyword">if</span> <span class="token punctuation">(</span>earliestTimeoutMs <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          absoluteTimeoutMs <span class="token operator">=</span> maxSigned31BitInt
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>startTimeMs <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> earliestExpirationTime <span class="token operator">=</span> <span class="token function">findEarliestOutstandingPriorityLevel</span><span class="token punctuation">(</span>
              root<span class="token punctuation">,</span>
              renderExpirationTime<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">const</span> earliestExpirationTimeMs <span class="token operator">=</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span>
              earliestExpirationTime<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            startTimeMs <span class="token operator">=</span> earliestExpirationTimeMs <span class="token operator">-</span> <span class="token constant">LOW_PRIORITY_EXPIRATION</span>
          <span class="token punctuation">}</span>
          absoluteTimeoutMs <span class="token operator">=</span> startTimeMs <span class="token operator">+</span> earliestTimeoutMs
        <span class="token punctuation">}</span>
        <span class="token function">renderDidSuspend</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> absoluteTimeoutMs<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span>

        workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> ShouldCapture
        workInProgress<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> renderExpirationTime
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// This boundary already captured during this render. Continue to the next</span>
      <span class="token comment">// boundary.</span>
      workInProgress <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>return
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token comment">// No boundary was found. Fallthrough to error mode.</span>
    value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token string">'An update was suspended, but no placeholder UI was provided.'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// error handle</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react/start.html" class="prev">
        React是如何调度任务的
      </a></span> <span class="next"><a href="/react/suspense.html">
        开启
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.99b5bf8c.js" defer></script><script src="/assets/js/2.733019b2.js" defer></script><script src="/assets/js/33.81844ad5.js" defer></script>
  </body>
</html>
