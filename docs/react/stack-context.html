<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Stack | 王亚宁的个人学习</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.1a8e0fbc.css" as="style"><link rel="preload" href="/assets/js/app.d6181b04.js" as="script"><link rel="preload" href="/assets/js/2.733019b2.js" as="script"><link rel="preload" href="/assets/js/53.71ce7e45.js" as="script"><link rel="prefetch" href="/assets/js/10.3fb17185.js"><link rel="prefetch" href="/assets/js/11.df13f98f.js"><link rel="prefetch" href="/assets/js/12.b66383ee.js"><link rel="prefetch" href="/assets/js/13.0a23e10b.js"><link rel="prefetch" href="/assets/js/14.366841cb.js"><link rel="prefetch" href="/assets/js/15.d25f8a51.js"><link rel="prefetch" href="/assets/js/16.08f21664.js"><link rel="prefetch" href="/assets/js/17.1061e257.js"><link rel="prefetch" href="/assets/js/18.8a4c6d2b.js"><link rel="prefetch" href="/assets/js/19.85149716.js"><link rel="prefetch" href="/assets/js/20.3eb847ee.js"><link rel="prefetch" href="/assets/js/21.15e6c8fe.js"><link rel="prefetch" href="/assets/js/22.d19be237.js"><link rel="prefetch" href="/assets/js/23.f58c749b.js"><link rel="prefetch" href="/assets/js/24.31132eef.js"><link rel="prefetch" href="/assets/js/25.85eb4b5d.js"><link rel="prefetch" href="/assets/js/26.968591fe.js"><link rel="prefetch" href="/assets/js/27.aff14ef6.js"><link rel="prefetch" href="/assets/js/28.ce9ce64f.js"><link rel="prefetch" href="/assets/js/29.8db63817.js"><link rel="prefetch" href="/assets/js/3.64b6d7b3.js"><link rel="prefetch" href="/assets/js/30.2ba176e5.js"><link rel="prefetch" href="/assets/js/31.9644ac6d.js"><link rel="prefetch" href="/assets/js/32.52962b52.js"><link rel="prefetch" href="/assets/js/33.d9c1010b.js"><link rel="prefetch" href="/assets/js/34.86d8e9ce.js"><link rel="prefetch" href="/assets/js/35.397ddd83.js"><link rel="prefetch" href="/assets/js/36.1df7fc65.js"><link rel="prefetch" href="/assets/js/37.e79a8c36.js"><link rel="prefetch" href="/assets/js/38.ff716bf7.js"><link rel="prefetch" href="/assets/js/39.84c24b83.js"><link rel="prefetch" href="/assets/js/4.da3ef268.js"><link rel="prefetch" href="/assets/js/40.0b62ac91.js"><link rel="prefetch" href="/assets/js/41.cdb6b048.js"><link rel="prefetch" href="/assets/js/42.836f874d.js"><link rel="prefetch" href="/assets/js/43.b50e313c.js"><link rel="prefetch" href="/assets/js/44.b899823e.js"><link rel="prefetch" href="/assets/js/45.58edc359.js"><link rel="prefetch" href="/assets/js/46.bbbe1817.js"><link rel="prefetch" href="/assets/js/47.80a908bf.js"><link rel="prefetch" href="/assets/js/48.f6d4302a.js"><link rel="prefetch" href="/assets/js/49.42c4f7d9.js"><link rel="prefetch" href="/assets/js/5.dac787d8.js"><link rel="prefetch" href="/assets/js/50.3c483839.js"><link rel="prefetch" href="/assets/js/51.65b0a3ae.js"><link rel="prefetch" href="/assets/js/52.e8eebaf5.js"><link rel="prefetch" href="/assets/js/54.70b9b23b.js"><link rel="prefetch" href="/assets/js/55.902a834f.js"><link rel="prefetch" href="/assets/js/56.ccfea6ae.js"><link rel="prefetch" href="/assets/js/57.98a426e4.js"><link rel="prefetch" href="/assets/js/58.48d2d884.js"><link rel="prefetch" href="/assets/js/59.64f96906.js"><link rel="prefetch" href="/assets/js/6.820ab661.js"><link rel="prefetch" href="/assets/js/60.79e25a48.js"><link rel="prefetch" href="/assets/js/61.702571c0.js"><link rel="prefetch" href="/assets/js/62.f4d96841.js"><link rel="prefetch" href="/assets/js/63.b239a95e.js"><link rel="prefetch" href="/assets/js/64.9376960a.js"><link rel="prefetch" href="/assets/js/65.40597fe8.js"><link rel="prefetch" href="/assets/js/66.aae02cce.js"><link rel="prefetch" href="/assets/js/67.dbb30cd0.js"><link rel="prefetch" href="/assets/js/68.705ba71c.js"><link rel="prefetch" href="/assets/js/69.79d30799.js"><link rel="prefetch" href="/assets/js/7.22edff0c.js"><link rel="prefetch" href="/assets/js/70.68b46478.js"><link rel="prefetch" href="/assets/js/71.5874de26.js"><link rel="prefetch" href="/assets/js/72.01d3455f.js"><link rel="prefetch" href="/assets/js/8.8733fc27.js"><link rel="prefetch" href="/assets/js/9.76eb16d3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1a8e0fbc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">王亚宁的个人学习</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/react/react.html" class="nav-link">
  我学习的react
</a></div><div class="nav-item"><a href="/vue/v-model.html" class="nav-link">
  我学习的vue
</a></div><div class="nav-item"><a href="/JavaScript/深入原理/闭包.html" class="nav-link">
  我学习的javascript
</a></div><div class="nav-item"><a href="https://w-yaning.github.io/react-book/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Jokcy react 文档
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/react/react.html" class="nav-link">
  我学习的react
</a></div><div class="nav-item"><a href="/vue/v-model.html" class="nav-link">
  我学习的vue
</a></div><div class="nav-item"><a href="/JavaScript/深入原理/闭包.html" class="nav-link">
  我学习的javascript
</a></div><div class="nav-item"><a href="https://w-yaning.github.io/react-book/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Jokcy react 文档
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>react源码</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/react.html" class="sidebar-link">React</a></li><li><a href="/react/ref.html" class="sidebar-link">createRef</a></li><li><a href="/react/scheduler.html" class="sidebar-link">React是如何调度任务的</a></li><li><a href="/react/react-16.6.html" class="sidebar-link">React16.6</a></li><li><a href="/react/react-scheduler.html" class="sidebar-link">react scheduler</a></li><li><a href="/react/component.html" class="sidebar-link">React.Component</a></li><li><a href="/react/context.html" class="sidebar-link">Stack</a></li><li><a href="/react/diff-properties.html" class="sidebar-link">diffProperties</a></li><li><a href="/react/finalizeInitialChildren.html" class="sidebar-link">finalizeInitialChildren</a></li><li><a href="/react/hooks-common.html" class="sidebar-link">阅读源码后，来讲讲React Hokks是怎么实现的</a></li><li><a href="/react/hooks.html" class="sidebar-link">从源码看Hooks</a></li><li><a href="/react/complete-unit-of-work.html" class="sidebar-link">completeUnitOfWork</a></li><li><a href="/react/complete-work.html" class="sidebar-link">completeWork</a></li><li><a href="/react/pending-priority-methods.html" class="sidebar-link">markPendingPriorityLevel</a></li><li><a href="/react/pending-priority.html" class="sidebar-link">PendingPriority</a></li><li><a href="/react/stack-context.html" aria-current="page" class="active sidebar-link">Stack</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/react/start.html" class="sidebar-link">React是如何调度任务的</a></li><li><a href="/react/suspense-core.html" class="sidebar-link">Suspense</a></li><li><a href="/react/suspense.html" class="sidebar-link">开启</a></li><li><a href="/react/time.html" class="sidebar-link">Time About</a></li><li><a href="/react/unwind-work.html" class="sidebar-link">unwindWork</a></li><li><a href="/react/update-queue.html" class="sidebar-link">updateQueue</a></li><li><a href="/react/why-new-context-api.html" class="sidebar-link">Context API</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="stack"><a href="#stack" class="header-anchor">#</a> Stack</h1> <p>在 React 的更新过程中有一个<code>Stack</code>模块，在遍历每个节点的过程中，会扮演存储上下文的一个角色，他会存储很多信息，让我们来一一分解讲解。</p> <p>首先我们来讲一下<code>Stack</code>的构成</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token literal-property property">valueStack</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>

<span class="token keyword">function</span> createCursor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>defaultValue<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">current</span><span class="token operator">:</span> defaultValue<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">return</span> index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> pop<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>cursor<span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  cursor<span class="token punctuation">.</span>current <span class="token operator">=</span> valueStack<span class="token punctuation">[</span>index<span class="token punctuation">]</span>

  valueStack<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>

  index<span class="token operator">--</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> push<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>cursor<span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> <span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  index<span class="token operator">++</span>

  valueStack<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> cursor<span class="token punctuation">.</span>current

  cursor<span class="token punctuation">.</span>current <span class="token operator">=</span> value
<span class="token punctuation">}</span>
</code></pre></div><p>精简之后的核心模块代码如上，所有内容会存储在<code>valueStack</code>这个数组上，总体的操作都非常简单，我相信大家啊都能看得懂。</p> <p>而在这个唯一的数组上要存储以下不怎么相关的数据：</p> <ul><li><code>childContext</code></li> <li><code>NewContext</code></li> <li><code>HostContext</code></li> <li><code>HostContainer</code></li></ul> <p>为了能够在同一个栈中区分不同的功能，React 设计了一个<code>StackCursor</code>类型，用来区分不同的类型的数据的当前值。对于<code>cursor</code>的操作很简单，入栈的时候设置<code>cursor.current</code>为新的值，出栈的时候设置<code>cursor.current</code>为上一个值</p> <p>但是这里还存在一个问题，那就是数据入栈的顺序，如果入栈位置出栈的时候用的<code>cursor</code>不同，就会导致数据错乱。React 中防止出现这个问题的方式，是通过<strong>每个节点在 beginWork 的时候入栈，在 completeUnitOfWork 的时候出栈，严格按照遍历树的顺序</strong></p> <h1 id="childcontext"><a href="#childcontext" class="header-anchor">#</a> childContext</h1> <p><code>childContext</code>是 React 的遗留 API，在 17 版本中会被移除，该 API 对于 React 渲染的效率影响很大，不推荐继续使用。目前 React 源码中调用该 API 相关的方法会加上<code>Legacy</code>字样。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token literal-property property">contextStackCursor</span><span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">createCursor</span><span class="token punctuation">(</span>emptyContextObject<span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token literal-property property">didPerformWorkStackCursor</span><span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">createCursor</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre></div><p>这里存在三个<code>cursor</code></p> <h3 id="contextstackcursor"><a href="#contextstackcursor" class="header-anchor">#</a> contextStackCursor</h3> <p>记录当前组件和他的父树一起提供给子树的<code>childContext</code>对象，初始默认是<code>emptyContextObject {}</code>。</p> <p>对<code>FiberRoot</code>会执行第一次<code>push</code>，除非自行调用<code>renderSubtreeIntoContainer</code>，不然<code>root</code>的<code>context</code>都是<code>{}</code>，除了初次渲染，<code>push</code>的值都是<code>false</code>，表明目前<code>context</code>没有变化。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// updateHostRoot的时候会调用</span>
<span class="token keyword">function</span> <span class="token function">pushTopLevelContextObject</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">context</span><span class="token operator">:</span> Object<span class="token punctuation">,</span>
  <span class="token literal-property property">didChange</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token function">push</span><span class="token punctuation">(</span>contextStackCursor<span class="token punctuation">,</span> context<span class="token punctuation">,</span> fiber<span class="token punctuation">)</span>
  <span class="token function">push</span><span class="token punctuation">(</span>didPerformWorkStackCursor<span class="token punctuation">,</span> didChange<span class="token punctuation">,</span> fiber<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>之后只有<code>ClassComponent</code>能够提供<code>childContext</code>，在<code>updateClassComponent</code>的过程中会调用<code>pushContextProvider</code>来推入新的子树<code>context</code>对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">pushContextProvider</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode
  <span class="token keyword">const</span> memoizedMergedChildContext <span class="token operator">=</span>
    <span class="token punctuation">(</span>instance <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>__reactInternalMemoizedMergedChildContext<span class="token punctuation">)</span> <span class="token operator">||</span>
    emptyContextObject

  previousContext <span class="token operator">=</span> contextStackCursor<span class="token punctuation">.</span>current
  <span class="token function">push</span><span class="token punctuation">(</span>contextStackCursor<span class="token punctuation">,</span> memoizedMergedChildContext<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>
  <span class="token function">push</span><span class="token punctuation">(</span>
    didPerformWorkStackCursor<span class="token punctuation">,</span>
    didPerformWorkStackCursor<span class="token punctuation">.</span>current<span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">,</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到这里只是从<code>instance.__reactInternalMemoizedMergedChildContext</code>读取对象，但是在<code>updateClassComponent</code>调用这个方法的时候并没有计算出新的<code>state</code>，所以是否有新的<code>context</code>也是未知。注意这里给全局变量<code>previousContext</code>赋值了<code>contextStackCursor.current</code>，所以他是当前组件的父树提供的<code>context</code>的集合。在后续<code>finishClassComponent</code>的时候如果<code>state</code>或者<code>props</code>有更新，那么需要重新计算<code>context</code>，会执行<code>invalidateContextProvider</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">invalidateContextProvider</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">didChange</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode

  <span class="token keyword">if</span> <span class="token punctuation">(</span>didChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> mergedContext <span class="token operator">=</span> <span class="token function">processChildContext</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      type<span class="token punctuation">,</span>
      previousContext<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    instance<span class="token punctuation">.</span>__reactInternalMemoizedMergedChildContext <span class="token operator">=</span> mergedContext

    <span class="token function">pop</span><span class="token punctuation">(</span>didPerformWorkStackCursor<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>
    <span class="token function">pop</span><span class="token punctuation">(</span>contextStackCursor<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>
    <span class="token function">push</span><span class="token punctuation">(</span>contextStackCursor<span class="token punctuation">,</span> mergedContext<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>
    <span class="token function">push</span><span class="token punctuation">(</span>didPerformWorkStackCursor<span class="token punctuation">,</span> didChange<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">pop</span><span class="token punctuation">(</span>didPerformWorkStackCursor<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>
    <span class="token function">push</span><span class="token punctuation">(</span>didPerformWorkStackCursor<span class="token punctuation">,</span> didChange<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>processChildContext</code>会计算出新的<code>childContext</code>，然后赋值给<code>__reactInternalMemoizedMergedChildContext</code>，并且之前对于当前组件已经<code>push</code>过一次了，所以这里要先<code>pop</code>再<code>push</code>，而且两个<code>cursor</code>的顺序要调换。而如果新老<code>context</code>都没有变化，会设置<code>didPerformWorkStackCursor</code>为<code>false</code>，可以优化子树，不需要执行不必要的更新。<strong>注意这里的<code>didChange</code>跟<code>shouldComponentUpdate</code>有关，另外需要注意<code>PureComponent</code>不会判断<code>context</code>是否变化。</strong></p> <h3 id="didperformworkstackcursor"><a href="#didperformworkstackcursor" class="header-anchor">#</a> didPerformWorkStackCursor</h3> <p>这个就是用来标记子树的<code>context</code>是否变化的，在以上的代码中已经很明显了，所以就不再分析。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">hasContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">return</span> didPerformWorkStackCursor<span class="token punctuation">.</span>current
<span class="token punctuation">}</span>
</code></pre></div><h1 id="newcontext"><a href="#newcontext" class="header-anchor">#</a> NewContext</h1> <p>这个是新的<code>Context API</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token literal-property property">valueCursor</span><span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span>mixed<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">createCursor</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</code></pre></div><p>相对来说他的逻辑会简单挺多，<code>Provider</code>处理如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> pushProvider<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>providerFiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> <span class="token literal-property property">nextValue</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">context</span><span class="token operator">:</span> ReactContext<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> providerFiber<span class="token punctuation">.</span>type<span class="token punctuation">.</span>_context
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isPrimaryRenderer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">push</span><span class="token punctuation">(</span>valueCursor<span class="token punctuation">,</span> context<span class="token punctuation">.</span>_currentValue<span class="token punctuation">,</span> providerFiber<span class="token punctuation">)</span>
    context<span class="token punctuation">.</span>_currentValue <span class="token operator">=</span> nextValue
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">push</span><span class="token punctuation">(</span>valueCursor<span class="token punctuation">,</span> context<span class="token punctuation">.</span>_currentValue2<span class="token punctuation">,</span> providerFiber<span class="token punctuation">)</span>
    context<span class="token punctuation">.</span>_currentValue2 <span class="token operator">=</span> nextValue
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">popProvider</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">providerFiber</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> currentValue <span class="token operator">=</span> valueCursor<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token function">pop</span><span class="token punctuation">(</span>valueCursor<span class="token punctuation">,</span> providerFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token literal-property property">context</span><span class="token operator">:</span> ReactContext<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">=</span> providerFiber<span class="token punctuation">.</span>type<span class="token punctuation">.</span>_context<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isPrimaryRenderer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>_currentValue <span class="token operator">=</span> currentValue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>_currentValue2 <span class="token operator">=</span> currentValue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ReactDOM中<code>isPrimaryRenderer</code>为<code>true</code>，注意这里设置了<code>context._currentValue</code>，在后续要用到<code>context</code>的时候，比如通过<code>Consumer</code>读取值，那么只需要读取这个值就可以了。</p> <p>在<code>React16.6</code>之后呢增加了<code>ClassComponent.contextType</code>快速订阅新API的方式，还有<code>hooks</code>中<code>functionalComponent</code>可以使用<code>useContext</code>订阅新API，所以呢这里有两个方法来处理这个逻辑：</p> <ul><li><code>propagateContextChange</code></li> <li><code>readContext</code></li></ul> <p>代码有点长，用个gist来方吧</p> <p><code>propagateContextChange</code>在<code>ContextProvider</code>检测到<code>context</code>的值有变化的情况下调用，他会遍历他的子树，找有<code>firstContextDependency</code>属性的<code>fiber</code>，并检测他是否有以来当前的<code>ContextProvider</code>，如果有的话会在这个组件上创建一个更新，并且这个更新的<code>expirationTime</code>是当前正在执行的更新的<code>expirationTime</code>，也就是说在这个渲染周期肯定会被渲染，因为创建了更新，所以肯定要更新<code>expirationTime</code>同时还要更新父链上的<code>childExpirationTime</code>。</p> <p>那么<code>firstContextDependency</code>哪里来的呢？就是在组件在调用<code>readContext</code>的时候，目前能看的源码（16.6）还没有<code>hooks</code>的源码，所以目前能看到的是<code>ClassCompnent.contextType</code>，对于这种情况他的依赖只会有一个，而<code>hooks</code>是可以读取多个的。</p> <p><code>observedBits</code>在目前的源码中没看到什么作用，虽然源码中<code>ContentConsumer</code>中可以使用<code>unstable_observedBits</code>这个属性，但是目前没有任何说明这是用来干嘛的。<em>猜测跟<code>hooks</code>有关？</em></p> <h1 id="hostcontext-hostcontainer"><a href="#hostcontext-hostcontainer" class="header-anchor">#</a> HostContext &amp; HostContainer</h1> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token literal-property property">contextStackCursor</span><span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span>HostContext <span class="token operator">|</span> NoContextT<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">createCursor</span><span class="token punctuation">(</span>
  <span class="token constant">NO_CONTEXT</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token literal-property property">contextFiberStackCursor</span><span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span>Fiber <span class="token operator">|</span> NoContextT<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">createCursor</span><span class="token punctuation">(</span>
  <span class="token constant">NO_CONTEXT</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token literal-property property">rootInstanceStackCursor</span><span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span>Container <span class="token operator">|</span> NoContextT<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">createCursor</span><span class="token punctuation">(</span>
  <span class="token constant">NO_CONTEXT</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里主管的内容有：</p> <h3 id="pushhostcontainer"><a href="#pushhostcontainer" class="header-anchor">#</a> pushHostContainer</h3> <p>对于<code>HostRoot</code>和<code>Proatl</code>他们会有挂载节点，所以会有<code>container</code></p> <h3 id="pushhostcontext"><a href="#pushhostcontext" class="header-anchor">#</a> pushHostContext</h3> <p>这个是用来对原生节点进行入栈的操作，主要记录的是<code>NameSpace</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">HTML_NAMESPACE</span> <span class="token operator">=</span> <span class="token string">'http://www.w3.org/1999/xhtml'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">MATH_NAMESPACE</span> <span class="token operator">=</span> <span class="token string">'http://www.w3.org/1998/Math/MathML'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">SVG_NAMESPACE</span> <span class="token operator">=</span> <span class="token string">'http://www.w3.org/2000/svg'</span><span class="token punctuation">;</span>

<span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">'svg'</span><span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token constant">SVG_NAMESPACE</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">'math'</span><span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token constant">MATH_NAMESPACE</span><span class="token punctuation">;</span>
  <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token constant">HTML_NAMESPACE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react/pending-priority.html" class="prev">
        PendingPriority
      </a></span> <span class="next"><a href="/react/start.html">
        React是如何调度任务的
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d6181b04.js" defer></script><script src="/assets/js/2.733019b2.js" defer></script><script src="/assets/js/53.71ce7e45.js" defer></script>
  </body>
</html>
